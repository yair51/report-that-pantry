{% extends "base.html" %}

{% block title %} {{ pantry.name }} - Report That Pantry {% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                {% if pantry.photo %}
                <img src="{{ current_app.config['S3_LOCATION'] + pantry.photo }}" 
                    class="card-img-top" alt="Pantry Photo">
                {% endif %}
                <div class="card-body">
                    <h2 class="card-title">{{ pantry.name }}</h2>
                    <p class="card-text">{{ pantry.address }} {{ pantry.city }}, {{ pantry.state }}, {{ pantry.zip }}</p>
                    
                    <div class="status-section mt-3">
                        <h3>Current Status</h3>
                        <div class="progress" style="height: 20px; position: relative;"> 
                            <div class="progress-bar 
                                {% if latest_report.pantry_fullness <= 33 %}
                                    bg-danger
                                {% elif latest_report.pantry_fullness <= 67 %}
                                    bg-warning
                                {% else %}
                                    bg-success
                                {% endif %}" 
                                role="progressbar" 
                                style="width: {% if latest_report.pantry_fullness < 10 %}10{% else %}{{ latest_report.pantry_fullness }}{% endif %}%;"
                                aria-valuenow="{{ latest_report.pantry_fullness }}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                                {{ latest_report.pantry_fullness }}% Full
                            </div>
                        </div>
                        <p class="report-time" data-utc-time="{{ latest_report.time.isoformat() }}">Last Updated: {{ latest_report.time.strftime('%Y-%m-%d %H:%M') if latest_report.time else 'N/A' }}</p> 
                        <form action="/location/subscribe/{{pantry.id}}" class="d-flex" method="POST" style="margin: 0px;"> 
                            <a href="{{ url_for('views.report', id=pantry.id) }}" class="btn btn-primary mr-2">Report Status</a> 
                            {% if user.is_authenticated %}
                            <button id="subscribe-button" class="btn btn-{{ 'danger' if pantry.id in subscribed_locations else 'success' }}"> 
                                {% if pantry.id in subscribed_locations %}
                                    Unsubscribe
                                {% else %}
                                    Subscribe
                                {% endif %}
                            </button>
                        {% else %}
                        <a href="/login" class="btn btn-success">Log In to Subscribe</a>
                        {% endif %}
                        </form>

                    </div>

                    <!-- Analytics Section -->
                    {% if analytics %}
                    <div class="analytics-section mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3><i class="fas fa-chart-line"></i> Analytics & Trends</h3>
                            {% if can_edit %}
                                <a href="/api/analytics/{{ pantry.id }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-download"></i> Export Data
                                </a>
                            {% endif %}
                        </div>
                        
                        <!-- Quick Stats Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3 col-sm-6 mb-2">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center p-3">
                                        <h5 class="card-title mb-1">{{ analytics.total_reports }}</h5>
                                        <p class="card-text small mb-0">Total Reports</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-2">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center p-3">
                                        <h5 class="card-title mb-1">{{ analytics.fullness_stats.average }}%</h5>
                                        <p class="card-text small mb-0">Average Fullness</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-2">
                                <div class="card 
                                    {% if analytics.trends.direction == 'improving' %}
                                        bg-success
                                    {% elif analytics.trends.direction == 'declining' %}
                                        bg-warning
                                    {% else %}
                                        bg-secondary
                                    {% endif %} text-white">
                                    <div class="card-body text-center p-3">
                                        <h5 class="card-title mb-1">
                                            {% if analytics.trends.direction == 'improving' %}
                                                <i class="fas fa-arrow-up"></i>
                                            {% elif analytics.trends.direction == 'declining' %}
                                                <i class="fas fa-arrow-down"></i>
                                            {% else %}
                                                <i class="fas fa-minus"></i>
                                            {% endif %}
                                        </h5>
                                        <p class="card-text small mb-0">{{ analytics.trends.direction|title }} Trend</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-2">
                                <div class="card 
                                    {% if analytics.engagement.unique_reporters >= 5 %}
                                        bg-success
                                    {% elif analytics.engagement.unique_reporters >= 2 %}
                                        bg-warning
                                    {% else %}
                                        bg-danger
                                    {% endif %} text-white">
                                    <div class="card-body text-center p-3">
                                        <h5 class="card-title mb-1">{{ analytics.engagement.unique_reporters }}</h5>
                                        <p class="card-text small mb-0">Active Reporters</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Predictive Insights Alert -->
                        {% if analytics.predictions and analytics.predictions.days_until_empty %}
                        <div class="alert 
                            {% if analytics.predictions.risk_level == 'high' %}
                                alert-danger
                            {% elif analytics.predictions.risk_level == 'medium' %}
                                alert-warning
                            {% else %}
                                alert-info
                            {% endif %} mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Prediction:</strong> Based on recent trends, this pantry may be empty in 
                            <strong>{{ analytics.predictions.days_until_empty }} days</strong>
                            {% if analytics.predictions.risk_level == 'high' %}
                                - Consider restocking soon!
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Advanced Prediction Chart -->
                        {% if analytics.predictions and analytics.predictions.chart_data %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-crystal-ball"></i> Predictive Analysis</h5>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-3">
                                            Confidence: <strong>{{ analytics.predictions.confidence }}%</strong>
                                        </small>
                                        <span class="badge 
                                            {% if analytics.predictions.risk_level == 'critical' %}
                                                bg-danger
                                            {% elif analytics.predictions.risk_level == 'high' %}
                                                bg-warning
                                            {% elif analytics.predictions.risk_level == 'medium' %}
                                                bg-info
                                            {% else %}
                                                bg-success
                                            {% endif %}">
                                            {{ analytics.predictions.risk_level|title }} Risk
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <canvas id="predictionChart" width="400" height="250"></canvas>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="prediction-details">
                                            <h6><i class="fas fa-info-circle"></i> Prediction Details</h6>
                                            
                                            {% if analytics.predictions.days_until_empty %}
                                            <div class="prediction-stat mb-3">
                                                <strong>Estimated Empty Date:</strong><br>
                                                <span class="h5 text-{{ 'danger' if analytics.predictions.risk_level in ['critical', 'high'] else 'warning' if analytics.predictions.risk_level == 'medium' else 'success' }}">
                                                    {{ analytics.predictions.days_until_empty }} days
                                                </span>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="prediction-method mb-3">
                                                <strong>Analysis Method:</strong><br>
                                                <small class="text-muted">{{ analytics.predictions.prediction_explanation }}</small>
                                            </div>
                                            
                                            {% if analytics.predictions.alternative_predictions %}
                                            <div class="alternative-methods">
                                                <h6 class="text-muted">Alternative Predictions:</h6>
                                                {% for alt in analytics.predictions.alternative_predictions %}
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>{{ alt.method|title }}:</span>
                                                    <span><strong>{{ alt.days }} days</strong> ({{ alt.confidence }}%)</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            
                                            {% if analytics.predictions.factors %}
                                            <div class="mt-3 pt-3 border-top">
                                                <h6 class="text-muted">Key Factors:</h6>
                                                <ul class="list-unstyled small">
                                                    <li><i class="fas fa-chart-line text-info"></i> Trend: {{ analytics.predictions.factors.recent_trend|title }}</li>
                                                    <li><i class="fas fa-percentage text-info"></i> Current: {{ analytics.predictions.factors.current_fullness }}% full</li>
                                                    {% if analytics.predictions.factors.historical_depletion_events > 0 %}
                                                    <li><i class="fas fa-history text-info"></i> {{ analytics.predictions.factors.historical_depletion_events }} depletion events analyzed</li>
                                                    {% endif %}
                                                    {% if analytics.predictions.factors.weekly_pattern_available %}
                                                    <li><i class="fas fa-calendar text-info"></i> Weekly usage patterns detected</li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        Predictions are based on historical data and current trends. Actual usage may vary based on community needs and restocking patterns.
                                        <span class="d-inline-block ms-2">
                                            <span style="color: #007bff;">●</span> Historical Data
                                            <span style="color: #dc3545;" class="ms-2">●</span> Prediction
                                            <span style="color: rgba(220, 53, 69, 0.3);" class="ms-2">▬</span> Confidence Range
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Fullness Trend Chart -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-chart-area"></i> Fullness Over Time</h5>
                                    <small class="text-muted">
                                        <span class="badge" style="background-color: #dc3545; color: #dc3545;">●</span> Empty/Low (≤33%)
                                        <span class="badge ml-1" style="background-color: #ffc107; color: #ffc107;">●</span> Half Full (34-67%)
                                        <span class="badge ml-1" style="background-color: #28a745; color: #28a745;">●</span> Full (≥68%)
                                    </small>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="fullnessChart" width="400" height="200"></canvas>
                            </div>
                        </div>

                        <!-- Time Period Trends Chart -->
                        {% if analytics.time_trends.has_weekly_data or analytics.time_trends.has_monthly_data or analytics.time_trends.has_yearly_data %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Period Trends</h5>
                                    <div class="btn-group btn-group-sm" role="group" id="trend-buttons">
                                        {% if analytics.time_trends.has_weekly_data %}
                                            <button type="button" class="btn btn-outline-primary active trend-btn" data-period="weekly">Weekly</button>
                                        {% endif %}
                                        {% if analytics.time_trends.has_monthly_data %}
                                            <button type="button" class="btn btn-outline-primary{% if not analytics.time_trends.has_weekly_data %} active{% endif %} trend-btn" data-period="monthly">Monthly</button>
                                        {% endif %}
                                        {% if analytics.time_trends.has_yearly_data %}
                                            <button type="button" class="btn btn-outline-primary{% if not analytics.time_trends.has_weekly_data and not analytics.time_trends.has_monthly_data %} active{% endif %} trend-btn" data-period="yearly">Yearly</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="trendsChart" width="400" height="200"></canvas>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        Shows average fullness per period with error bars indicating min/max values
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Usage Patterns -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-calendar-week"></i> Activity Patterns</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Most Active Day:</strong> {{ analytics.patterns.most_active_day or 'N/A' }}</p>
                                        <p class="mb-2"><strong>Least Active Day:</strong> {{ analytics.patterns.least_active_day or 'N/A' }}</p>
                                        <p class="mb-2"><strong>Critical Periods:</strong> {{ analytics.patterns.critical_periods }} reports ≤10% full</p>
                                        {% if analytics.patterns.peak_depletion_hours %}
                                            <p class="mb-0"><strong>Peak Usage Hours:</strong> 
                                                {% for hour in analytics.patterns.peak_depletion_hours[:2] %}
                                                    {{ hour }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Fullness Distribution</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="distributionChart" width="300" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Restocking & Community Insights -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-sync-alt"></i> Restocking Patterns</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Restocking Events:</strong> {{ analytics.restocking.total_restocking_events }}</p>
                                        <p class="mb-2"><strong>Frequency:</strong> {{ analytics.restocking.restocking_frequency_per_week }} per week</p>
                                        {% if analytics.restocking.average_restock_time_hours %}
                                            <p class="mb-2"><strong>Avg Time Empty:</strong> 
                                                {% if analytics.restocking.average_restock_time_hours < 24 %}
                                                    {{ "%.1f"|format(analytics.restocking.average_restock_time_hours) }} hours
                                                {% else %}
                                                    {{ "%.1f"|format(analytics.restocking.average_restock_time_hours / 24) }} days
                                                {% endif %}
                                            </p>
                                        {% endif %}
                                        {% if analytics.restocking.average_depletion_time_hours %}
                                            <p class="mb-0"><strong>Avg Depletion Time:</strong> 
                                                {% if analytics.restocking.average_depletion_time_hours < 24 %}
                                                    {{ "%.1f"|format(analytics.restocking.average_depletion_time_hours) }} hours
                                                {% else %}
                                                    {{ "%.1f"|format(analytics.restocking.average_depletion_time_hours / 24) }} days
                                                {% endif %}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-users"></i> Community Engagement</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Unique Reporters:</strong> {{ analytics.engagement.unique_reporters }}</p>
                                        <p class="mb-2"><strong>Anonymous Reports:</strong> {{ analytics.engagement.anonymous_reports }}</p>
                                        <p class="mb-2"><strong>Avg Reports/User:</strong> {{ analytics.engagement.average_reports_per_user }}</p>
                                        <p class="mb-0"><strong>Engagement Rate:</strong> {{ analytics.engagement.engagement_rate }} reporters/week</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Insights -->
                        {% if analytics.ai_insights and analytics.ai_insights.total_ai_reports > 0 %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-robot"></i> AI Analysis Insights</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>AI Reports:</strong> {{ analytics.ai_insights.total_ai_reports }} of {{ analytics.total_reports }} ({{ analytics.ai_insights.ai_coverage_percentage }}%)</p>
                                        {% if analytics.ai_insights.average_ai_fullness %}
                                            <p class="mb-2"><strong>Average AI Fullness:</strong> {{ analytics.ai_insights.average_ai_fullness }}%</p>
                                        {% endif %}
                                        {% if analytics.ai_insights.average_organization %}
                                            <p class="mb-0"><strong>Average Organization Score:</strong> {{ analytics.ai_insights.average_organization }}/100</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {% if analytics.ai_insights.most_common_items %}
                                            <p class="mb-2"><strong>Most Common Items:</strong></p>
                                            <ul class="mb-0 small">
                                                {% for item, count in analytics.ai_insights.most_common_items %}
                                                    <li>{{ item }} ({{ count }} times)</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Detailed Stats -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Detailed Statistics</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Data Range:</strong> {{ analytics.date_range.start.strftime('%Y-%m-%d') }} to {{ analytics.date_range.end.strftime('%Y-%m-%d') }}</p>
                                        <p class="mb-1"><strong>Tracking Period:</strong> {{ analytics.date_range.days }} days</p>
                                        <p class="mb-1"><strong>Minimum Fullness:</strong> {{ analytics.fullness_stats.minimum }}%</p>
                                        <p class="mb-0"><strong>Maximum Fullness:</strong> {{ analytics.fullness_stats.maximum }}%</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Recent Trend:</strong> {{ analytics.trends.recent_average }}% average (last 5 reports)</p>
                                        <p class="mb-1"><strong>Change from Previous:</strong> 
                                            {% if analytics.trends.change_from_previous > 0 %}
                                                <span class="text-success">+{{ analytics.trends.change_from_previous }}%</span>
                                            {% elif analytics.trends.change_from_previous < 0 %}
                                                <span class="text-danger">{{ analytics.trends.change_from_previous }}%</span>
                                            {% else %}
                                                <span class="text-muted">No change</span>
                                            {% endif %}
                                        </p>
                                        <p class="mb-0"><strong>Reports per Week:</strong> {{ "%.1f"|format(analytics.total_reports / (analytics.date_range.days / 7)) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="analytics-section mt-4">
                        <h3><i class="fas fa-chart-line text-muted"></i> Analytics & Trends</h3>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Analytics will be available after at least 2 reports have been submitted for this pantry.
                        </div>
                    </div>
                    {% endif %}

                    <div class="details-section mt-4">
                        <h3>Details</h3>
                        {% if pantry.description %}
                            <p>Description: {{ pantry.description }}</p>
                        {% endif %}
                        {% if pantry.contact_info %}
                            <p>Contact Info: {{ pantry.contact_info }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="reporting-history mt-4">
                        <h3>Reporting History</h3>
                        {% if pantry.reports|length > 0 %}
                            <ul class="list-group">
                                {% for report in pantry.reports %}
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <span class="report-time fw-bold" data-utc-time="{{ report.time.isoformat() }}">
                                                    {{ report.time.strftime('%Y-%m-%d %H:%M') }}
                                                </span>
                                                <span class="ms-2">
                                                    <span class="badge 
                                                        {% if report.pantry_fullness <= 33 %}
                                                            bg-danger
                                                        {% elif report.pantry_fullness <= 67 %}
                                                            bg-warning
                                                        {% else %}
                                                            bg-success
                                                        {% endif %}">
                                                        {{ report.pantry_fullness }}% Full
                                                    </span>
                                                </span>
                                                
                                                {% if report.description %}
                                                    <p class="mt-2 mb-1 text-muted small">{{ report.description }}</p>
                                                {% endif %}
                                                
                                                <!-- Vision API Analysis Results -->
                                                {% set vision_analysis = report.get_vision_analysis() %}
                                                {% if vision_analysis and vision_analysis.get('food_items') %}
                                                    <div class="mt-2">
                                                        <small class="text-info">
                                                            <i class="fas fa-robot"></i> AI Analysis:
                                                        </small>
                                                        <div class="mt-1">
                                                            <small>
                                                                <strong>Detected items:</strong> 
                                                                {% for item in report.get_detected_food_items() %}
                                                                    <span class="badge bg-light text-dark me-1">{{ item }}</span>
                                                                {% endfor %}
                                                            </small>
                                                        </div>
                                                        {% set ai_fullness = report.get_ai_fullness_estimate() %}
                                                        {% if ai_fullness is not none %}
                                                            <div class="mt-1">
                                                                <small>
                                                                    <strong>AI fullness estimate:</strong> {{ ai_fullness }}%
                                                                    {% set fullness_diff = (report.pantry_fullness - ai_fullness)|abs %}
                                                                    {% if fullness_diff > 20 %}
                                                                        <span class="text-warning">(differs from user report by {{ fullness_diff }}%)</span>
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                        {% endif %}
                                                        {% set org_score = report.get_organization_score() %}
                                                        {% if org_score is not none and org_score > 0 %}
                                                            <div class="mt-1">
                                                                <small>
                                                                    <strong>Organization score:</strong> {{ "%.0f"|format(org_score) }}/100
                                                                </small>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if report.photo %} 
                                                <div class="ms-3"> 
                                                    <a href="{{ current_app.config['S3_LOCATION'] + report.photo }}" data-toggle="modal" data-target="#photoModal">
                                                        <img src="{{ current_app.config['S3_LOCATION'] + report.photo }}" class="img-thumbnail" style="width: 80px; height: 60px; object-fit: cover;" alt="Report Photo">
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No reports available.</p>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3>Actions</h3>
                </div>
                <div class="card-body">
                    <a href="https://www.google.com/maps/search/?api=1&query={{ pantry.latitude }},{{ pantry.longitude }}&zoom=16" target="_blank" class="btn btn-secondary btn-block mb-2">View on Google Maps</a>
                    {% if user.is_authenticated and user.id == pantry.user_id %}
                        <a href="{{ url_for('views.edit_location', location_id=pantry.id) }}" class="btn btn-info btn-block mb-2">Edit Location</a>
                        <a href="{{ url_for('views.poster', id=pantry.id, isNew1=1) }}" class="btn btn-success btn-block">Get QR Code</a> 
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="photoModal" tabindex="-1" role="dialog" aria-labelledby="photoModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="photoModalLabel">Report Photo</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body mx-auto">
              <img id="modal-image"
       src="" class="img-fluid" alt="Report Photo">
            </div>
          </div>
        </div>
    </div>
</div>

  {% endblock %}


  {% block script %}
<!-- Chart.js for analytics charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Data Generation Script -->
{% if analytics %}
<script>
window.pantryAnalyticsData = {
    hasAnalytics: true,
    {% if analytics.predictions and analytics.predictions.chart_data %}
    predictionData: {{ analytics.predictions.chart_data | tojson | safe }},
    {% else %}
    predictionData: [],
    {% endif %}
    {% if analytics.chart_data and analytics.chart_data.data_points %}
    chartData: {{ analytics.chart_data.data_points | tojson | safe }},
    {% else %}
    chartData: [],
    {% endif %}
    {% if analytics.chart_data and analytics.chart_data.fullness_distribution %}
    distributionData: {{ analytics.chart_data.fullness_distribution | tojson | safe }},
    {% else %}
    distributionData: {},
    {% endif %}
    {% if analytics.trends_data %}
    trendsData: {{ analytics.trends_data | tojson | safe }}
    {% else %}
    trendsData: {}
    {% endif %}
};
</script>
{% else %}
<script>
window.pantryAnalyticsData = {
    hasAnalytics: false,
    predictionData: [],
    chartData: [],
    distributionData: {},
    trendsData: {}
};
</script>
{% endif %}

<script>
$(document).ready(function() {
    $('#photoModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); 
        var imageUrl = button.attr('href'); 
        var modal = $(this);
        modal.find('.modal-body #modal-image').attr('src', imageUrl);
    })
});

    document.addEventListener('DOMContentLoaded', function() {
        const reportTimes = document.querySelectorAll('.report-time');
        reportTimes.forEach(function(reportTime) {
            const utcTime = reportTime.getAttribute('data-utc-time');
            const localTime = new Date(utcTime);
            const now = new Date();
            const diffInMinutes = Math.floor((now - localTime) / 60000); // Difference in minutes
            let timeAgo;
            if (diffInMinutes < 60) {
                timeAgo = `${diffInMinutes} minutes ago`;
            } else {
                const diffInHours = Math.floor(diffInMinutes / 60); // Difference in hours
                if (diffInHours < 24) {
                    timeAgo = `${diffInHours} hours ago`;
                } else {
                    timeAgo = localTime.toLocaleString(); // Fallback to local time string
                }
            }

            reportTime.textContent = timeAgo;
        });
    });

    // Analytics Charts
    if (window.pantryAnalyticsData && window.pantryAnalyticsData.hasAnalytics) {
        console.log('Analytics data available');
        
        // Check if Chart.js is loaded
        if (typeof Chart !== 'undefined') {
            
            try {
                
                // Extract data from global object
                const predictionData = window.pantryAnalyticsData.predictionData || [];
                const chartData = window.pantryAnalyticsData.chartData || [];
                const distributionData = window.pantryAnalyticsData.distributionData || {};
                
                // Fullness Trend Chart with proper time-based x-axis
                const fullnessCtx = document.getElementById('fullnessChart')?.getContext('2d');
                
                // Fullness Distribution Pie Chart
                const distributionCtx = document.getElementById('distributionChart')?.getContext('2d');
    
    // Advanced Prediction Chart
    {% if analytics.predictions and analytics.predictions.chart_data %}
    const predictionCtx = document.getElementById('predictionChart')?.getContext('2d');
    
    if (predictionCtx && predictionData && predictionData.length > 0) {
        // Separate historical and prediction data
        const historicalData = predictionData.filter(d => !d.is_prediction);
        const predictionDataPoints = predictionData.filter(d => d.is_prediction);
        
        // Create datasets
        const datasets = [];
        
        // Historical data line
        if (historicalData.length > 0) {
            datasets.push({
                label: 'Current Status',
                data: [{
                    x: historicalData[0].date,
                    y: historicalData[0].projected_fullness
                }],
                borderColor: '#007bff',
                backgroundColor: '#007bff',
                borderWidth: 3,
                pointRadius: 8,
                pointHoverRadius: 10,
                fill: false,
                tension: 0.1
            });
        }
        
        // Prediction line
        if (predictionDataPoints.length > 0) {
            const allPredictionPoints = [...(historicalData.length > 0 ? [historicalData[0]] : []), ...predictionDataPoints];
            
            datasets.push({
                label: 'Predicted Trend',
                data: allPredictionPoints.map(d => ({
                    x: d.date,
                    y: d.projected_fullness
                })),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false,
                tension: 0.1
            });
            
            // Confidence interval
            datasets.push({
                label: 'Confidence Range',
                data: allPredictionPoints.map(d => ({
                    x: d.date,
                    y: d.confidence_upper
                })),
                borderColor: 'rgba(220, 53, 69, 0.3)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 1,
                pointRadius: 0,
                fill: '+1',
                tension: 0.1
            });
            
            datasets.push({
                label: 'Confidence Lower',
                data: allPredictionPoints.map(d => ({
                    x: d.date,
                    y: d.confidence_lower
                })),
                borderColor: 'rgba(220, 53, 69, 0.3)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 1,
                pointRadius: 0,
                fill: false,
                tension: 0.1
            });
        }
        
        new Chart(predictionCtx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM DD'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Fullness (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            filter: function(legendItem, chartData) {
                                // Hide the confidence lower bound from legend
                                return legendItem.text !== 'Confidence Lower';
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return new Date(context[0].parsed.x).toLocaleDateString();
                            },
                            label: function(context) {
                                if (context.dataset.label === 'Confidence Range' || context.dataset.label === 'Confidence Lower') {
                                    return null; // Don't show tooltip for confidence bounds
                                }
                                const value = Math.round(context.parsed.y);
                                const isPrediction = context.parsed.x > new Date().getTime();
                                const prefix = isPrediction ? 'Predicted: ' : 'Current: ';
                                return prefix + value + '%';
                            }
                        },
                        filter: function(tooltipItem) {
                            // Don't show tooltips for confidence bounds
                            return tooltipItem.dataset.label !== 'Confidence Range' && 
                                   tooltipItem.dataset.label !== 'Confidence Lower';
                        }
                    }
                }
            });
    }
    {% endif %}
    
    // Fullness Trend Chart with proper time-based x-axis
    const fullnessCtx = document.getElementById('fullnessChart').getContext('2d');
    
    // Prepare data with actual timestamps for proper time series
    const chartData = {{ analytics.chart_data.data_points | tojson | safe }};
    
    // Check if chartData exists and has length
    if (chartData && chartData.length > 0) {
        // Create color arrays based on fullness levels
        const pointColors = chartData.map(point => {
            if (point.fullness <= 33) {
                return '#dc3545'; // Red for empty/low
            } else if (point.fullness <= 67) {
                return '#ffc107'; // Yellow for half full
            } else {
                return '#28a745'; // Green for full
            }
        });
        
        const fullnessChart = new Chart(fullnessCtx, {
            type: 'line',
            data: {
                labels: chartData.map(point => {
                    const date = new Date(point.timestamp);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }),
                datasets: [{
                    label: 'User Reported Fullness',
                    data: chartData.map(point => point.fullness),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date & Time'
                        },
                        ticks: {
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Fullness (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const point = chartData[context[0].dataIndex];
                                return new Date(point.timestamp).toLocaleString();
                            },
                            label: function(context) {
                                const fullness = context.parsed.y;
                                let status;
                                if (fullness <= 33) {
                                    status = 'Empty/Low';
                                } else if (fullness <= 67) {
                                    status = 'Half Full';
                                } else {
                                    status = 'Full';
                                }
                                return `Fullness: ${fullness}% (${status})`;
                            }
                        }
                    }
                }
            });
    } else {
        // Show error message if no data
        document.getElementById('fullnessChart').style.display = 'none';
        const chartContainer = document.querySelector('#fullnessChart').parentElement;
        chartContainer.innerHTML = '<p class="text-muted text-center">No chart data available</p>';
    }

    // Fullness Distribution Pie Chart
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    
    // Get distribution data from Jinja
    const distributionData = {{ analytics.chart_data.fullness_distribution | tojson | safe }};
    
    // Check if analytics data exists
    if (distributionData) {
        const distributionChart = new Chart(distributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Empty/Low (≤33%)', 'Medium (34-66%)', 'Full (≥67%)'],
                datasets: [{
                    data: [
                        distributionData.empty + distributionData.low,
                        distributionData.medium,
                        distributionData.high + distributionData.full
                    ],
                    backgroundColor: [
                        '#dc3545',  // Red for empty/low
                        '#ffc107',  // Yellow for medium
                        '#28a745'   // Green for full
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' reports (' + percentage + '%)';
                            }
                        }
                    }
                }
            });
    } else {
        document.getElementById('distributionChart').style.display = 'none';
        const chartContainer = document.querySelector('#distributionChart').parentElement;
        chartContainer.innerHTML = '<p class="text-muted text-center">No distribution data available</p>';
    }
    
    // Time Period Trends Chart - SIMPLE IMPLEMENTATION
    {% if analytics.time_trends.has_weekly_data or analytics.time_trends.has_monthly_data or analytics.time_trends.has_yearly_data %}
    
    // Store trends data directly in JavaScript
    window.trendsData = {
        weekly: {{ analytics.time_trends.weekly | tojson | safe }},
        monthly: {{ analytics.time_trends.monthly | tojson | safe }},
        yearly: {{ analytics.time_trends.yearly | tojson | safe }}
    };
    
    const defaultPeriod = "{% if analytics.time_trends.has_weekly_data %}weekly{% elif analytics.time_trends.has_monthly_data %}monthly{% elif analytics.time_trends.has_yearly_data %}yearly{% endif %}";
    
    let trendsChart = null;
    
    // Simple function to show trend chart
    function switchTrendPeriod(period) {
        // Update buttons
        document.querySelectorAll('.trend-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-period') === period) {
                btn.classList.add('active');
            }
        });
        
        // Get data
        const data = window.trendsData[period];
        if (!data || !data.length) {
            return;
        }
        
        // Destroy existing chart
        if (trendsChart) {
            trendsChart.destroy();
        }
        
        // Create simple chart
        const canvas = document.getElementById('trendsChart');
        if (canvas) {
            trendsChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        label: 'Average Fullness',
                        data: data.map(d => d.average_fullness),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0,123,255,0.1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
    }
    
    // Setup event listeners when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Add click listeners to buttons
        document.querySelectorAll('.trend-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const period = this.getAttribute('data-period');
                switchTrendPeriod(period);
            });
        });
        
        // Initialize with default period
        if (defaultPeriod) {
            switchTrendPeriod(defaultPeriod);
        }
    });
    
    {% endif %}
    
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
    
    } else {
        console.error('Chart.js library is not loaded!');
    }
    
    } // End of analytics check

</script>
{% endblock %}